### DRUID ###
healer_druid = { "armor"                  : 0.0,
                 "agility"                : 0.0,
                 "intelligence"           : 1.0,
                 "spirit"                 : 0.5,
                 "stamina"                : 0.1,
                 "strength"               : 0.0,
                 "melee_crit_percentage"  : 0.0,
                 "melee_hit_percentage"   : 0.0,
                 "ranged_crit_percentage" : 0.0,
                 "ranged_hit_percentage"  : 0.0,
                 "attack_power"           : 0.0,
                 "ranged_attack_power"    : 0.0,
                 "spell_healing"          : 2.0,
                 "spell_power"            : 0.0,
                 "spell_crit_percentage"  : 1.0,
                 "spell_hit_percentage"   : 0.0,
                 "spell_penetration"      : 0.0,
                 "mana_per_5"             : 1.0,
                 "speed"                  : 0.0,
                 "dps"                    : 0.0}
feral_druid = { "armor"                  : 0.0,
                "agility"                : 0.0,
                "intelligence"           : 1.0,
                "spirit"                 : 0.5,
                "stamina"                : 0.1,
                "strength"               : 0.0,
                "melee_crit_percentage"  : 0.0,
                "melee_hit_percentage"   : 0.0,
                "ranged_crit_percentage" : 0.0,
                "ranged_hit_percentage"  : 0.0,
                "attack_power"           : 0.0,
                "ranged_attack_power"    : 0.0,
                "spell_healing"          : 2.0,
                "spell_power"            : 0.0,
                "spell_crit_percentage"  : 1.0,
                "spell_hit_percentage"   : 0.0,
                "spell_penetration"      : 0.0,
                "mana_per_5"             : 1.0,
                "speed"                  : 0.0,
                "dps"                    : 0.0}

### HUNTER ###
hunter = { "armor"                  : 0.0,
           "agility"                : 0.0,
           "intelligence"           : 1.0,
           "spirit"                 : 0.5,
           "stamina"                : 0.1,
           "strength"               : 0.0,
           "melee_crit_percentage"  : 0.0,
           "melee_hit_percentage"   : 0.0,
           "ranged_crit_percentage" : 0.0,
           "ranged_hit_percentage"  : 0.0,
           "attack_power"           : 0.0,
           "ranged_attack_power"    : 0.0,
           "spell_healing"          : 2.0,
           "spell_power"            : 0.0,
           "spell_crit_percentage"  : 1.0,
           "spell_hit_percentage"   : 0.0,
           "spell_penetration"      : 0.0,
           "mana_per_5"             : 1.0,
           "speed"                  : 0.0,
           "dps"                    : 0.0}

### MAGE ###
mage = { "armor"                  : 0.0,
         "agility"                : 0.0,
         "intelligence"           : 1.0,
         "spirit"                 : 0.5,
         "stamina"                : 0.1,
         "strength"               : 0.0,
         "melee_crit_percentage"  : 0.0,
         "melee_hit_percentage"   : 0.0,
         "ranged_crit_percentage" : 0.0,
         "ranged_hit_percentage"  : 0.0,
         "attack_power"           : 0.0,
         "ranged_attack_power"    : 0.0,
         "spell_healing"          : 2.0,
         "spell_power"            : 0.0,
         "spell_crit_percentage"  : 1.0,
         "spell_hit_percentage"   : 0.0,
         "spell_penetration"      : 0.0,
         "mana_per_5"             : 1.0,
         "speed"                  : 0.0,
         "dps"                    : 0.0}

### PALADIN ###
paladin = { "armor"                  : 0.0,
            "agility"                : 0.0,
            "intelligence"           : 1.0,
            "spirit"                 : 0.5,
            "stamina"                : 0.1,
            "strength"               : 0.0,
            "melee_crit_percentage"  : 0.0,
            "melee_hit_percentage"   : 0.0,
            "ranged_crit_percentage" : 0.0,
            "ranged_hit_percentage"  : 0.0,
            "attack_power"           : 0.0,
            "ranged_attack_power"    : 0.0,
            "spell_healing"          : 2.0,
            "spell_power"            : 0.0,
            "spell_crit_percentage"  : 1.0,
            "spell_hit_percentage"   : 0.0,
            "spell_penetration"      : 0.0,
            "mana_per_5"             : 1.0,
            "speed"                  : 0.0,
            "dps"                    : 0.0}

### PRIEST ###
healer_priest = { "armor"                  : 0.0,
                  "agility"                : 0.0,
                  "intelligence"           : 1.0,
                  "spirit"                 : 0.5,
                  "stamina"                : 0.1,
                  "strength"               : 0.0,
                  "melee_crit_percentage"  : 0.0,
                  "melee_hit_percentage"   : 0.0,
                  "ranged_crit_percentage" : 0.0,
                  "ranged_hit_percentage"  : 0.0,
                  "attack_power"           : 0.0,
                  "ranged_attack_power"    : 0.0,
                  "spell_healing"          : 2.0,
                  "spell_power"            : 0.0,
                  "spell_crit_percentage"  : 1.0,
                  "spell_hit_percentage"   : 0.0,
                  "spell_penetration"      : 0.0,
                  "mana_per_5"             : 1.0,
                  "speed"                  : 0.0,
                  "dps"                    : 0.0}

dps_priest = { "armor"                  : 0.0,
               "agility"                : 0.0,
               "intelligence"           : 1.0,
               "spirit"                 : 0.5,
               "stamina"                : 0.1,
               "strength"               : 0.0,
               "melee_crit_percentage"  : 0.0,
               "melee_hit_percentage"   : 0.0,
               "ranged_crit_percentage" : 0.0,
               "ranged_hit_percentage"  : 0.0,
               "attack_power"           : 0.0,
               "ranged_attack_power"    : 0.0,
               "spell_healing"          : 2.0,
               "spell_power"            : 0.0,
               "spell_crit_percentage"  : 1.0,
               "spell_hit_percentage"   : 0.0,
               "spell_penetration"      : 0.0,
               "mana_per_5"             : 1.0,
               "speed"                  : 0.0,
               "dps"                    : 0.0}

### ROGUE ###
rogue = { "armor"                  : 0.0,
          "agility"                : 0.0,
          "intelligence"           : 1.0,
          "spirit"                 : 0.5,
          "stamina"                : 0.1,
          "strength"               : 0.0,
          "melee_crit_percentage"  : 0.0,
          "melee_hit_percentage"   : 0.0,
          "ranged_crit_percentage" : 0.0,
          "ranged_hit_percentage"  : 0.0,
          "attack_power"           : 0.0,
          "ranged_attack_power"    : 0.0,
          "spell_healing"          : 2.0,
          "spell_power"            : 0.0,
          "spell_crit_percentage"  : 1.0,
          "spell_hit_percentage"   : 0.0,
          "spell_penetration"      : 0.0,
          "mana_per_5"             : 1.0,
          "speed"                  : 0.0,
          "dps"                    : 0.0}

### SHAMAN ###
healer_shaman = { "armor"                  : 0.0,
                  "agility"                : 0.0,
                  "intelligence"           : 1.0,
                  "spirit"                 : 0.5,
                  "stamina"                : 0.1,
                  "strength"               : 0.0,
                  "melee_crit_percentage"  : 0.0,
                  "melee_hit_percentage"   : 0.0,
                  "ranged_crit_percentage" : 0.0,
                  "ranged_hit_percentage"  : 0.0,
                  "attack_power"           : 0.0,
                  "ranged_attack_power"    : 0.0,
                  "spell_healing"          : 2.0,
                  "spell_power"            : 0.0,
                  "spell_crit_percentage"  : 1.0,
                  "spell_hit_percentage"   : 0.0,
                  "spell_penetration"      : 0.0,
                  "mana_per_5"             : 1.0,
                  "speed"                  : 0.0,
                  "dps"                    : 0.0}

### WARLOCK ###
warlock = { "armor"                  : 0.0,
            "agility"                : 0.0,
            "intelligence"           : 1.0,
            "spirit"                 : 0.5,
            "stamina"                : 0.1,
            "strength"               : 0.0,
            "melee_crit_percentage"  : 0.0,
            "melee_hit_percentage"   : 0.0,
            "ranged_crit_percentage" : 0.0,
            "ranged_hit_percentage"  : 0.0,
            "attack_power"           : 0.0,
            "ranged_attack_power"    : 0.0,
            "spell_healing"          : 2.0,
            "spell_power"            : 0.0,
            "spell_crit_percentage"  : 1.0,
            "spell_hit_percentage"   : 0.0,
            "spell_penetration"      : 0.0,
            "mana_per_5"             : 1.0,
            "speed"                  : 0.0,
            "dps"                    : 0.0}

### WARRIOR ###
warrior = { "armor"                  : 0.0,
            "agility"                : 0.0,
            "intelligence"           : 1.0,
            "spirit"                 : 0.5,
            "stamina"                : 0.1,
            "strength"               : 0.0,
            "melee_crit_percentage"  : 0.0,
            "melee_hit_percentage"   : 0.0,
            "ranged_crit_percentage" : 0.0,
            "ranged_hit_percentage"  : 0.0,
            "attack_power"           : 0.0,
            "ranged_attack_power"    : 0.0,
            "spell_healing"          : 2.0,
            "spell_power"            : 0.0,
            "spell_crit_percentage"  : 1.0,
            "spell_hit_percentage"   : 0.0,
            "spell_penetration"      : 0.0,
            "mana_per_5"             : 1.0,
            "speed"                  : 0.0,
            "dps"                    : 0.0}




def player_stat_totals(player_id, loot_db_handle):
  items = loot_db_handle.get_items_of_player(player_id)
  stat_sum = {}
  for item in items:
    for key in item.keys():
      if key == "name" or key == "id":
        continue
      if key in stat_sum:
        stat_sum[key] = stat_sum[key] + item[key]
      else:
        stat_sum[key] = item[key]
  return stat_sum
      
  

def calculate_recommendation_score(player, loot_db_handle, new_item, old_item):
  classes = loot_db_handle.get_class_name_list()
  spec_tag = classes[player["class"]][0]
  role = "UNKNOWN"
  
  if spec_tag.lower() == "druid":
    #determine type of druid
    #if stacking int or spell healing more than str or agi probably a healer
    stats = player_stat_totals(player["id"], loot_db_handle)  
    #TODO add function to calculate top stat
    if stats["intelligence"] > stats["strength"] and stats["intelligence"] > stats["agility"]:
      #is caster
      stat_weight = healer_druid
      role = "Healer"
    else:
      #is melee so probably feral
      stat_weight = feral_druid
      role = "DPS"
      
  elif spec_tag.lower() == "hunter":
    stat_weight = hunter
    role = "DPS"
  elif spec_tag.lower() == "mage":
    stat_weight = mage
    role = "DPS"
  elif spec_tag.lower() == "paladin":
    stat_weight = paladin
    role = "UNKNOWN"
  elif spec_tag.lower() == "priest":
    stat_weight = healer_priest
    role = "Healer"
  elif spec_tag.lower() == "rogue":
    stat_weight = rogue
    role = "DPS"
  elif spec_tag.lower() == "shaman":
    stat_weight = healer_shaman
    role = "Healer"
  elif spec_tag.lower() == "warlock":
    stat_weight = warlock
    role = "DPS"
  elif spec_tag.lower() == "warrior":
    stat_weight = warrior
    role = "DPS"
  else:
    print ("UNKNOWN")
    return False
    
  new_item_score = 0
  old_item_score = 0
  stat_change = {}
  for key, value in stat_weight.items():
    new_item_score = new_item_score + new_item[key] * value
    old_item_score = old_item_score + old_item[key] * value
    stat_change[key] = new_item[key] - old_item[key]
  
  item_upgrade_dict = {"name" : player["name"],
                       "role" : role,
                       "spec" : spec_tag,
                       "score_uplift" : new_item_score - old_item_score,
                       "new_item_name" : new_item["name"],
                       "new_item_score" : new_item_score,
                       "old_item_name" : old_item["name"],
                       "old_item_score" : old_item_score,
                       "stat_change_dict" : stat_change}
  return item_upgrade_dict
    


    


